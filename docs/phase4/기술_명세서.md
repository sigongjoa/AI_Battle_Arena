# Phase 4 기술 명세서: WebRTC 기반 강화학습 환경

## 1. 개요
이 문서는 Python으로 구현된 강화학습(RL) 에이전트와 브라우저의 게임 클라이언트 간의 실시간 연동을 위한 상세 기술 명세를 정의한다. 시스템 아키텍처, 통신 프로토콜, 데이터 모델, 각 모듈의 API 및 의존성을 포함한다.

---

## 2. 시스템 아키텍처 및 통신 패턴

### 2.1. 동기-비동기 브릿지 (Sync-Async Bridge)
-   **문제**: `Stable-Baselines3`와 같은 RL 라이브러리는 `env.step()`을 동기적으로 호출하지만, WebRTC 통신(`aiortc`)은 비동기적으로 동작한다.
-   **해결책**: 별도의 **스레드**에서 `aiortc`의 `asyncio` 이벤트 루프를 실행하고, 메인 스레드(RL 학습)와는 **Thread-safe Queue** (`queue.Queue`)를 통해 데이터를 주고받는 '브릿지' 패턴을 사용한다.

    ```mermaid
    sequenceDiagram
        participant Main as Main Thread (Sync)
        participant WebRTC as WebRTC Thread (Async)

        Main->>WebRTC: action_queue.put(action)
        Note left of Main: result_queue.get()에서 블로킹 대기
        WebRTC->>WebRTC: 비동기적으로 action 전송 및 결과 수신
        WebRTC->>Main: result_queue.put(result)
        Note left of Main: 블로킹 해제 후 결과 반환
    ```

### 2.2. Lock-Step 통신
-   **정의**: RL 에이전트의 학습 환경에서는 재현성과 순서 보장이 매우 중요하다. 본 시스템은 `FightingEnv`의 `step` 메서드가 프론트엔드로부터 `step_result`를 받을 때까지 블로킹 대기하는 **'Lock-Step'** 방식을 채택한다.
-   **효과**: 이 1:1 요청-응답 구조는 통신 순서가 꼬이는 Race Condition을 원천적으로 방지하며, 학습 환경의 안정성을 보장한다.

---

## 3. 데이터 모델 및 프로토콜

### 3.1. 공통 데이터 프로토콜 (JSON API)
WebRTC 데이터 채널을 통해 교환되는 모든 메시지는 다음 JSON 형식을 따른다.

-   **백엔드 -> 프론트엔드**
    -   `{ "type": "action", "action": <number> }`: 에이전트의 행동 전달
    -   `{ "type": "reset" }`: 게임 환경 초기화 명령

-   **프론트엔드 -> 백엔드**
    -   `{ "type": "step_result", "observation": <number[]>, "reward": <number>, "done": <boolean> }`: 행동 수행 결과 보고
    -   `{ "type": "reset_result", "observation": <number[]> }`: 초기화 결과 보고
    -   `{ "type": "connection_ready" }`: 데이터 채널 연결 완료 알림

### 3.2. 관측 공간 (Observation Space)
-   **타입**: `gym.spaces.Box` / `number[]`
-   **설명**: 게임 상태를 정규화한 숫자 배열.

| 인덱스 | 내용 | 정규화 범위 |
| :--- | :--- | :--- |
| 0-1 | P1의 (x, y) 좌표 | `0.0` ~ `1.0` |
| 2 | P1의 체력 | `0.0` ~ `1.0` |
| 3 | P1의 상태 (Enum) | `0` ~ `N` |
| 4-5 | P2의 (x, y) 좌표 | `0.0` ~ `1.0` |
| 6 | P2의 체력 | `0.0` ~ `1.0` |
| 7 | P2의 상태 (Enum) | `0` ~ `N` |

### 3.3. 행동 공간 (Action Space)
-   **타입**: `gym.spaces.Discrete` / `number`
-   **설명**: AI가 할 수 있는 이산적인 행동의 집합.

| 값 | 행동 | 설명 |
| :-- | :--- | :--- |
| 0 | `IDLE` | 가만히 있기 |
| 1 | `MOVE_FWD` | 앞으로 이동 |
| 2 | `MOVE_BWD` | 뒤로 이동 |
| 3 | `JUMP` | 점프 |
| 4 | `ATTACK_1` | 기본 공격 1 |
| 5 | `ATTACK_2` | 기본 공격 2 |

---

## 4. 백엔드 (Python) 명세

### 4.1. `WebRTCClient` 클래스 (`src/webrtc_client.py`)
-   **역할**: `aiortc`를 사용한 WebRTC 연결 및 데이터 교환의 복잡한 비동기 로직을 캡슐화한다.
-   **주요 메서드**:
    -   `__init__(action_queue, result_queue)`: 메인 스레드와 통신할 큐를 초기화한다.
    -   `run(peer_id)`: 스레드의 진입점. `asyncio` 이벤트 루프를 시작하고 `connect`를 호출한다.
    -   `async connect(peer_id)`: PeerJS 시그널링 서버에 연결하고 데이터 채널을 설정한다.
    -   `async close()`: 모든 WebRTC 연결을 종료한다.

### 4.2. `FightingEnv` 클래스 (`src/fighting_env.py`)
-   **역할**: OpenAI Gym 인터페이스를 유지하며, 내부적으로 `WebRTCClient`와 큐를 통해 프론트엔드와 통신한다.
-   **주요 메서드**:
    -   `__init__(peer_id)`: `WebRTCClient` 스레드를 시작하고 `connection_ready` 신호를 받을 때까지 대기한다.
    -   `step(action)`: `action_queue`에 액션을 넣고, `result_queue`에서 결과가 올 때까지 블로킹 대기 후 반환한다.
    -   `reset()`: `action_queue`에 리셋 명령을 넣고, `result_queue`에서 초기 상태가 올 때까지 블로킹 대기 후 반환한다.
    -   `close()`: `WebRTCClient` 스레드를 안전하게 종료시킨다.

---

## 5. 프론트엔드 (TypeScript) 명세

### 5.1. `RLAgentController.tsx` 컴포넌트
-   **역할**: 백엔드 RL 에이전트와의 WebRTC 통신을 총괄하는 Headless 컴포넌트.
-   **로직**: `useEffect` 내에서 PeerJS 객체를 생성하고, props로 받은 `backendPeerId`에 연결을 시도한다. 데이터 채널의 `data` 이벤트를 수신하여 게임 엔진에 액션을 전달하고, 게임 엔진의 결과를 다시 백엔드로 전송한다.

### 5.2. `engine.ts` 인터페이스
-   **역할**: 외부(RL 에이전트)로부터의 제어를 허용하는 인터페이스를 제공한다.
-   **주요 함수**:
    -   `applyExternalAction(action: number)`: 숫자 `action`을 실제 게임 입력으로 변환하여 적용한다.
    -   `getObservationForAgent(): number[]`: 현재 게임 상태를 숫자 배열로 수집하여 반환한다.

### 5.3. Import/Export 전략
-   `tsconfig.json`에 정의된 `@/*` alias를 사용하여 절대 경로 기반의 `import`를 강제한다. (`@`는 `arcade-clash/` 루트)

---

## 6. 주요 의존성 및 버전

| 영역 | 라이브러리 | 버전 | 역할 |
| :--- | :--- | :--- | :--- |
| Backend | `stable-baselines3` | - | 강화학습 모델 학습 및 관리 |
| Backend | `gymnasium` | - | 강화학습 환경 표준 인터페이스 |
| Backend | `peerpy` | (추가 필요) | PeerJS 서버와 통신을 간소화하는 WebRTC 클라이언트 |
| Frontend| `react` | `^18.2.0` | UI 렌더링 |
| Frontend| `peerjs` | `^1.5.4` | WebRTC 연결 설정 클라이언트 |

---

## 7. 예외 처리 및 오류 정책

-   **WebRTC 연결 실패**: `FightingEnv` 초기화 시 60초, `step` 실행 시 10초의 타임아웃을 설정한다. 타임아웃 발생 시, 백엔드는 예외를 발생시켜 학습을 중단하고 현재까지의 모델을 저장한다. 프론트엔드는 재연결 시도 후 실패 시 오류 메시지를 표시한다.
-   **잘못된 데이터 수신**: API 명세에 없는 메시지 수신 시, 해당 메시지를 무시하고 콘솔에 경고를 로깅한다.
