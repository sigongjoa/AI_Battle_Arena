# 롤백 넷코드 구현 및 리팩토링 테스트 계획서

이 문서는 `PeerJS`와 `msgpack-lite` 라이브러리를 적용하여 롤백 넷코드 아키텍처를 구현하고, 그 과정과 결과를 검증하기 위한 테스트 계획을 정의합니다.

---

### 1. 테스트 환경 (Test Environment)

*   **애플리케이션 환경:**
    *   **프론트엔드:** Vite 개발 서버 (`npm run dev`)
    *   **백엔드:** Python 기반의 WebRTC 시그널링 서버 (`backend/signaling/server.py`)

*   **테스트 프레임워크:**
    *   **단위/통합 테스트:** `Vitest`와 `@testing-library/react`를 사용합니다.
    *   **E2E 테스트:** `chrome-devtools` (MCP)를 사용하여 실제 브라우저 환경에서의 사용자 흐름을 테스트합니다.

*   **네트워크 시뮬레이션:**
    *   테스트의 핵심 요소로, 브라우저 개발자 도구(Chrome DevTools의 Network Throttling)를 사용하여 다양한 네트워크 지연(Latency) 및 패킷 손실(Packet Loss) 환경을 시뮬레이션합니다.
    *   **테스트 프로파일:**
        *   **양호:** 30ms RTT, 0% 패킷 손실
        *   **보통:** 80ms RTT, 1% 패킷 손실
        *   **나쁨:** 150ms RTT, 3% 패킷 손실

---

### 2. 테스트 진행 방향 (Test Procedure)

테스트는 기능 구현 단계에 맞춰 순차적으로 진행합니다.

#### 1단계: `PeerJS` 통합 및 연결 테스트

`WebRtcClient.ts`의 연결 로직을 `PeerJS` 기반으로 통합한 후, P2P 연결 기능이 정상 동작하는지 확인합니다.

1.  **단위 테스트:**
    *   통합된 `WebRtcClient`가 `PeerJS` 인스턴스를 올바르게 생성하는지 확인합니다.
    *   `PeerJS`의 `open` 이벤트가 발생했을 때, 시그널링 클라이언트를 통해 로컬 피어 ID를 전송하는 로직을 테스트합니다.
    *   `PeerJS`의 `connection` 이벤트가 발생했을 때, 데이터 연결이 올바르게 수립되는지 확인합니다.
2.  **통합 테스트:**
    *   `WebRtcClient` 인스턴스 두 개를 생성하고, 실제 시그널링 서버를 통해 서로 피어 ID를 교환하여 `PeerJS` 데이터 연결이 수립되는지 확인합니다.
3.  **E2E 테스트 (`chrome-devtools` 사용):**
    *   `mcp_테스트_가이드.md`에 따라 두 명의 사용자가 로비에 접속하고 매치를 맺는 과정을 자동화합니다.
    *   최종적으로 두 사용자 간에 P2P 연결이 수립되는지(콘솔 로그 또는 상태 확인) 검증합니다.

#### 2단계: `msgpack-lite` 직렬화 테스트

`PlayerInput`, `GameStateSnapshot` 등의 객체를 바이너리 데이터로 변환하여 데이터 채널로 주고받는 기능을 테스트합니다.

1.  **단위 테스트:**
    *   `PlayerInput` 객체를 `msgpack.encode`로 인코딩하고, 다시 `msgpack.decode`로 디코딩했을 때 원래 객체와 동일한지 검증하는 테스트 코드를 작성합니다.
2.  **통합 테스트:**
    *   1단계에서 연결된 P2P 데이터 채널(`simple-peer`의 `data` 이벤트)을 통해 인코딩된 `PlayerInput` 바이너리 데이터를 전송합니다.
    *   상대방 피어에서 데이터를 수신하고, 성공적으로 디코딩하여 원래 값을 복원할 수 있는지 확인합니다.

#### 3단계: 결정론 및 롤백 로직 테스트

게임의 핵심인 결정론적 실행과 롤백의 기초를 테스트합니다.

1.  **결정론 테스트 (Determinism Test):**
    *   동일한 입력 로그 파일(.json)을 사용하여 두 개의 게임 엔진 인스턴스를 실행합니다.
    *   매 프레임마다 각 인스턴스의 게임 상태(`GameState`) 체크섬(Checksum)을 계산하고, 두 체크섬이 100% 일치하는지 비교하는 테스트 러너를 작성하여 검증합니다.
2.  **상태 저장/복원 테스트:**
    *   게임 엔진의 특정 프레임 상태를 저장(`saveState`)하고, 다른 프레임에서 해당 상태를 완벽하게 복원(`loadState`)할 수 있는지 테스트합니다.

---

### 3. 테스트 성공 판단 기준 (Success Criteria)

*   **P2P 연결:**
    *   `PeerJS` 통합 후에도, 시뮬레이션된 네트워크 환경(양호, 보통, 나쁨)에서 **P2P 연결 성공률이 95% 이상**이어야 합니다.
    *   `WebRtcClient.ts`의 코드가 이전보다 간결하고 이해하기 쉬워야 합니다.

*   **데이터 직렬화:**
    *   `msgpack-lite`로 인코딩된 바이너리 데이터가 데이터 채널을 통해 오류 없이 송수신되어야 합니다.
    *   직렬화된 데이터의 크기가 **JSON 문자열 대비 최소 30% 이상 감소**해야 합니다.
    *   데이터 인코딩/디코딩에 소요되는 시간이 1ms 미만이어야 합니다.

*   **결정론 및 롤백:**
    *   **(가장 중요)** 결정론 테스트 시, 동일한 입력에 대해 두 게임 엔진의 **상태 체크섬이 모든 프레임에서 100% 일치**해야 합니다. 단 하나의 비트도 달라서는 안 됩니다.
    *   게임 상태를 저장하고 복원했을 때, 데이터가 완벽하게 일치해야 합니다.
