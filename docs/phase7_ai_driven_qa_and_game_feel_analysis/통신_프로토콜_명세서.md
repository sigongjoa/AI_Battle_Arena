# Phase 7: 통신 프로토콜 명세서 (v2.1 - WebRTC 기반)

## 1. 개요

본 문서는 AI 기반 자동 QA 시스템의 각 컴포넌트 간에 교환되는 데이터의 구조와 형식을 정의한다. 모든 데이터는 `JSON`을 기반으로 하며, 명확한 스키마를 통해 데이터의 일관성과 정합성을 보장한다.

## 2. 핵심 프로토콜

### 2.1. Simulation Arena ↔ RL Agent (WebRTC Data Channel) (v2.1)

RL 에이전트와 게임 시뮬레이션 간의 실시간 통신을 위해 **WebRTC Data Channel**을 사용한다. 이는 `PeerJS`를 통한 시그널링과 P2P 연결 수립 후, 데이터 채널을 통해 게임 상태(Observation), 에이전트 행동(Action), 보상(Reward), 게임 종료 여부(Done)를 교환하는 방식이다.

#### 2.1.1. 통신 흐름
1.  **PeerJS 인스턴스 생성:** `Simulation Arena`와 `RL Agent`는 각각 고유한 `PeerJS` 인스턴스를 생성하고, 시그널링 서버(`backend/signaling/server.py`)에 등록하여 `peer_id`를 얻는다.
2.  **Peer ID 교환:** 시그널링 서버를 통해 서로의 `peer_id`를 교환한다.
3.  **P2P 연결 수립:** `Simulation Arena` (또는 `RL Agent`)가 상대방 `peer_id`를 사용하여 `PeerJS.connect()`를 호출, P2P 연결을 시도한다.
4.  **데이터 채널 개설:** P2P 연결이 수립되면, `GameInput`, `GameStateSync`와 유사한 데이터 채널을 개설하여 게임 데이터를 교환한다.

#### 2.1.2. 데이터 채널 메시지 구조 (JSON)

WebRTC 데이터 채널을 통해 교환되는 주요 메시지 구조는 다음과 같다. `JSON` 형식으로 직렬화하여 전송한다.

##### `Observation` 메시지 (Simulation Arena -> RL Agent)
- **목적:** 게임의 현재 상태를 RL 에이전트에 전달.
- **데이터 구조:**
  ```json
  {
    "type": "observation",
    "frame": 12345,
    "player1": {
      "pos_x": 100.5,
      "pos_y": 50.2,
      "hp": 100,
      "state": 2 // 0:idle, 1:move, 2:attack, ...
    },
    "player2": {
      "pos_x": 120.0,
      "pos_y": 50.2,
      "hp": 80,
      "state": 1
    },
    "frame_advantage": 5.0
  }
  ```

##### `Action` 메시지 (RL Agent -> Simulation Arena)
- **목적:** RL 에이전트의 행동 명령을 게임 시뮬레이션에 전달.
- **데이터 구조:**
  ```json
  {
    "type": "action",
    "frame": 12345, // 해당 액션이 적용될 게임 프레임
    "direction": 1, // 0:neutral, 1:forward, ...
    "attack": 2,    // 0:none, 1:light, 2:medium, ...
    "defense": 0,   // 0:none, 1:guard
    "jump": 0       // 0:none, 1:jump
  }
  ```

##### `Reward` 및 `Done` 메시지 (Simulation Arena -> RL Agent)
- **목적:** 에이전트의 행동에 대한 보상과 게임 종료 여부를 전달.
- **데이터 구조:**
  ```json
  {
    "type": "reward_done",
    "frame": 12345,
    "reward": 0.5,
    "done": false
  }
  ```

### 2.2. Log Collector: 이벤트 로그 형식 (JSONL) (v2.0)

`JSON Lines` 형식의 텍스트 파일로 기록된다.

#### 로그 파일 예시: `events.jsonl` (v2.0)

```json
 {"timestamp": "2025-10-08T14:20:10.123Z", "event_type": "GAME_START", "data": {"map": "Training_Room", "p1_char": "Ryu", "p2_char": "Ken", "p1_persona": "pro_gamer", "p2_persona": "beginner"}}
 {"timestamp": "2025-10-08T14:20:11.500Z", "event_type": "HUMAN_ERROR_INJECTED_EVENT", "data": {"player": "P2", "original_action": {"attack": 2}, "modified_action": {"attack": 1}, "error_type": "mistake"}}
 {"timestamp": "2025-10-08T14:20:12.456Z", "event_type": "HIT_EVENT", "data": {"attacker": "P1", "defender": "P2", "damage": 10, ...}}
 {"timestamp": "2025-10-08T14:20:13.100Z", "event_type": "RHYTHM_METRIC_EVENT", "data": {"player": "P1", "metric_name": "CounterPlayScore", "value": 0.95}}
 {"timestamp": "2025-10-08T14:20:45.100Z", "event_type": "GAME_END", "data": {"winner": "P1", "reason": "K.O."}}
 {"timestamp": "2025-10-08T14:21:00.000Z", "event_type": "XAI_EVIDENCE_LINK_EVENT", "data": {"finding_id": "balance_issue_01", "evidence_type": "video_clip", "path": "/reports/clips/session_id/clip_01.mp4", "start_frame": 12345, "end_frame": 12567}}
 ```

#### (확장) 주요 이벤트 타입 (`event_type`)
- `GAME_START`, `GAME_END`, `STATE_CHANGE`, `HIT_EVENT`, `INPUT_EVENT`, `PERF_SPIKE`, `ERROR_EVENT` (v1.0)
- **(추가) `HUMAN_ERROR_INJECTED_EVENT`:** '인간적 실수 레이어'가 동작했을 때 기록.
- **(추가) `RHYTHM_METRIC_EVENT`:** '리듬' 기반 지표가 계산되었을 때 기록.
- **(추가) `XAI_EVIDENCE_LINK_EVENT`:** 리포트의 특정 분석 결과와 근거 데이터를 연결하기 위해 기록.

## 3. 데이터베이스 스키마 (SQLite) (v2.0)

`Report Database`에 저장될 테이블의 스키마 정의.

### `sessions`, `matches`, `metrics_summary` 테이블
- (v1.0과 거의 동일. `metrics_summary`에 페르소나별 점수를 저장하기 위한 컬럼 추가 가능)

### `balance_details` 테이블 (v2.0)
- **(수정)** `persona_id` 컬럼을 추가하여 페르소나별 밸런스 데이터를 분리하여 저장.
- `id` (PK), `session_id` (FK), **`persona_id` (TEXT)**, `char_name` (TEXT), `win_rate` (REAL), ...

### (추가) `xai_evidence` 테이블
- XAI 리포트의 가설과 근거 데이터를 매핑하는 테이블.
- `evidence_id` (PK, INTEGER): 근거 데이터 ID
- `session_id` (FK, TEXT): 세션 ID
- `finding_id` (TEXT): 리포트 내의 분석 결과(가설)에 대한 고유 ID
- `evidence_type` (TEXT): 근거 데이터 종류 (`video_clip`, `log_file`, `heatmap` 등)
- `path` (TEXT): 근거 데이터 파일의 경로
- `description` (TEXT): 근거 데이터에 대한 간략한 설명
